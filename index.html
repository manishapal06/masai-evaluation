<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsightPulse</title>
    <head>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        /* Basic styling plus consitional row colors*/
        body{
            font-family:Arial;
            margin:20px;}
            .hidden{display:none;}
            table{width:100%; border-collapse:collapse;margin-top:10px;}
            th,td{border:1px solid #ccc;
            padding:8px;text-align:left;}
            th{cursor:pointer;}
            tr.green{background: #e0ffe0;}
            tr.yellow{background:#fff9e0;}
            tr,red{background:#ffe0e0;}
            .banner{padding:10px;margin:10px 0;}
            .offline{background:#f0ad4e;
            color:white;}
            .synced{background:#5cb85c;
            color:white;}
    </style>
    </head>
    <body>
        <div id="roleSelectDiv">
            <label>Select Role:</label>
            <button onclick="selectRole('agent')">Agent</button>
            <button onclick="selectRole('lead')">Lead</button>
        </div>
        <div id="agentDiv" class="hidden">
            <h2>Agent Feedback Form</h2>
            <div id="agentBanner" class="Banner hidden"></div>
            <form id="agentForm">
            <input required placeholder="Agent Name"id="agentName"><br>
            <input required placeholder="Client Company" id="company"/><br>
            <select id="department">
                <option>SaaS</option>
                <option>Hardware</option>
                <option>Consulting</option>
                <option>Other</option>
                </select><br/>
                <input type="number" required min="1"max="5"placeholder="Score(1-5)"id="score"/><br/>
                <input type="number"min="-100"max="100"placeholder="NPS(-100 to 100)"id="nps"/><br/>
                <textarea placeholder="Comment"id="comment"></textarea><br/>
                <button type="submit">Submit</button>
            </form>    
            </div>
            <div id="leadDiv" class="hidden">
                <h2>Lead Dashboard</h2>
                <div>
                    <button onclick="syncOffline()">Sync Now</button>
                    <div id="syncBanner" class="banner hidden"></div>
                </div>
                <div id="analyticsDiv"</div>
                    <div>
                        <label>Filter Dept:</label>
                        <select id="filterDept"><option value=""All</option><option>Saas</option><option>Hardware</option><option>Consulting</option><option>Other</option></select>
                        <input placeholder="Filter Agent"id="filterAgent"/>
                        <input placeholder="Search Customer or Agent"id="searchText"/>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortBy('agent')">Agent</th>
                                <th onclick="sortBy('company')">Company</th>
                                <th onclick="sortBy('department')">Dept</th>
                                <th onclick="sortBy('score')">Score</th>
                                <th onclick="sortBy('nps')">NPS</th>
                                <th>Comment</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <script>
                    // 1.Setup Firebase
                    const firebaseConfg={databaseURL:"YOUR_DB_URL",apikey:"YOUR_API_KEY",authDomain:"your-auth-domain",};
                    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ref = db.ref('feedbacks');
    ref.onValue(snapshot => {
      feedbacks = snapshot.exists() ? Object.values(snapshot.val()) : [];
      renderLead();
    });

    // 2. Role selection
    const role = localStorage.getItem('role');
    if(role) applyRole(role);
    function selectRole(r){
      localStorage.setItem('role', r);
      applyRole(r);
    }
    function applyRole(r){
      document.getElementById('roleSelectDiv').classList.add('hidden');
      document.getElementById(r === 'agent' ? 'agentDiv' : 'leadDiv').classList.remove('hidden');
    }

    //  3. Agent Form
    let feedbacks = [];
    const offlineKey = 'offlineQueue';
    document.getElementById('agentForm').onsubmit = e => {
      e.preventDefault();
      const entry = {
        agent: id('agentName').value,
        company: id('company').value,
        department: id('department').value,
        score: +id('score').value,
        nps: id('nps').value ? +id('nps').value : null,
        comment: id('comment').value,
        timestamp: Date.now(),
      };
      if(!navigator.onLine){
        saveOffline(entry);
        agentBanner('You are offline. Saved locally.', 'offline');
      } else {
        postFeedback(entry).then(() => {
          agentBanner('Submitted successfully', 'synced');
          document.getElementById('agentForm').reset();
        });
      }
    }
    function saveOffline(e){
      const q = JSON.parse(localStorage.getItem(offlineKey)||'[]');
      q.push(e);
      localStorage.setItem(offlineKey, JSON.stringify(q));
    }
    function agentBanner(msg,cls){
      const b=document.getElementById('agentBanner');
      b.textContent=msg; b.className='banner '+cls; b.classList.remove('hidden');
      setTimeout(()=>b.classList.add('hidden'),3000);
    }
    function postFeedback(e){
      return ref.push(e);
    }

    // 4. Sync for Lead
    function syncOffline(){
      const q = JSON.parse(localStorage.getItem(offlineKey)||'[]');
      if(!q.length) return showSync('No offline data to sync.', 'offline');
      const pushes = q.map(e => postFeedback(e));
      Promise.all(pushes).then(()=>{
        localStorage.removeItem(offlineKey);
        showSync('Synced offline entries.', 'synced');
      });
    }
    function showSync(msg, cls){
      const b=document.getElementById('syncBanner');
      b.textContent=msg; b.className='banner '+cls; b.classList.remove('hidden');
      setTimeout(()=>b.classList.add('hidden'),3000);
    }

    // 5. Lead View: filters, sorting, rendering
    let sortField='timestamp', ascending=false;
    ['filterDept','filterAgent','searchText'].forEach(id=>{
      id_(id).oninput = debounce(renderLead,300);
    });
    function sortBy(field){
      if(sortField===field) ascending=!ascending;
      else { sortField=field; ascending=true; }
      renderLead();
    }
    function renderLead(){
      let arr = [...feedbacks];
      // filtering
      const fd = id_('filterDept').value;
      const fa = id_('filterAgent').value.toLowerCase();
      const sr = id_('searchText').value.toLowerCase();
      arr = arr.filter(e=>{
        return (!fd || e.department===fd)
          && (!fa || e.agent.toLowerCase().includes(fa))
          && (!sr || e.agent.toLowerCase().includes(sr) || e.company.toLowerCase().includes(sr));
      });
      // sorting
      arr.sort((a,b)=> ascending? a[sortField]>b[sortField]?1:-1 : a[sortField]<b[sortField]?1:-1);

      // analytics
      analytics(arr);

      // table
      const tb=document.getElementById('tableBody');
      tb.innerHTML='';
      arr.forEach(e=>{
        const tr=document.createElement('tr');
        if(e.score>=4) tr.classList.add('green');
        else if(e.score>=2) tr.classList.add('yellow');
        else if(e.score<2 || (e.nps !== null && e.nps<=0)) tr.classList.add('red');
        ['agent','company','department','score','nps','comment'].forEach(f=>{
          const td=document.createElement('td');
          td.textContent = (e[f]!==null && e[f]!==undefined)? e[f] : '';
          tr.appendChild(td);
        });
        tb.appendChild(tr);
      });
    }

    // 6. Analytics using map/filter/reduce
    function analytics(arr){
      const total = arr.length;
      const avgScore = total? (arr.reduce((s,e)=>s+e.score,0)/total).toFixed(2) : 0;
      const avgNps = total? (arr.reduce((s,e)=>s+(e.nps||0),0)/total).toFixed(2) : 0;

      const deptStats = arr.reduce((acc,e)=>{
        (acc[e.department] ??= []).push(e.score);
        return acc;
      }, {});
      const bestDept = Object.entries(deptStats)
        .map(([d,scores])=>[d, scores.reduce((a,b)=>a+b,0)/scores.length])
        .sort((a,b)=>b[1]-a[1])[0]?.[0] || 'N/A';

      const agentNps = arr.reduce((acc,e)=>{
        (acc[e.agent] ??= []).push(e.nps||0); return acc;
      }, {});
      const topNpsVal = Math.max(...Object.values(agentNps).map(arr=>arr.reduce((s,v)=>s+v,0)/arr.length||0));
      const topAgents = Object.entries(agentNps).filter(([a,arr])=> {
        const avg=arr.reduce((s,v)=>s+v,0)/arr.length;
        return avg===topNpsVal;
      }).map(x=>x[0]);

      const lowCounts = arr.filter(e=>e.score<3)
        .reduce((acc,e)=>{
          acc[e.agent] = (acc[e.agent]||0)+1; return acc;
        }, {});
      const lowAgents = Object.entries(lowCounts).filter(([_,c])=>c>=3).map(x=>x[0]);

      id_('analyticsDiv').innerHTML = `
        <b>Total:</b> ${total} |
        <b>Avg Score:</b> ${avgScore} |
        <b>Avg NPS:</b> ${avgNps} |
        <b>Best Dept:</b> ${bestDept} |
        <b>Top Agent(s):</b> ${topAgents.join(', ')||'N/A'} |
        <b>Agents w/ ≥3 low scores:</b> ${lowAgents.join(', ')||'None'}
      `;
    }

    // ⚙️ Utils
    function id_(i){return document.getElementById(i);}
    function id(i){return id_(i);}
    function debounce(fn, ms){
      let t;
      return e=>{ clearTimeout(t); t=setTimeout(()=>fn(e), ms); };
    }
    window.addEventListener('online',()=> agentBanner('Back online!', 'synced'));
    window.addEventListener('offline',()=> agentBanner('You are offline.', 'offline'));
  </script>
</body>
</html>

                </script>
            </select>
        </form>
                    </div>
    </body>